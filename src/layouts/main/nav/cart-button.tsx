'use client';

import type { Theme, SxProps } from '@mui/material/styles';

import { useState, type MouseEvent } from 'react';

import Box from '@mui/material/Box';
import SvgIcon from '@mui/material/SvgIcon';
import { useTheme } from '@mui/material/styles';
import IconButton from '@mui/material/IconButton';
import useMediaQuery from '@mui/material/useMediaQuery';

import { useCart } from 'src/hooks/use-cart';

import { CartMenu } from './cart-menu';

// ----------------------------------------------------------------------

type Props = {
  sx?: SxProps<Theme>;
};

export function CartButton({ sx }: Props) {
  const theme = useTheme();
  const isMobile = useMediaQuery(theme.breakpoints.down('sm'));
  const { itemCount } = useCart();
  const [anchorEl, setAnchorEl] = useState<HTMLElement | null>(null);

  const handleClick = (event: MouseEvent<HTMLButtonElement>) => {
    setAnchorEl(event.currentTarget);
  };

  const handleClose = () => {
    setAnchorEl(null);
  };

  const open = Boolean(anchorEl);
  const buttonSx: SxProps<Theme> = [{ p: 0 }, ...(Array.isArray(sx) ? sx : sx ? [sx] : [])];

  return (
    <>
      <IconButton onClick={handleClick} sx={buttonSx} disableRipple disableTouchRipple>
        {isMobile ? (
          <Box
            sx={{
              position: 'relative',
              width: 36,
              height: 36,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
            }}
          >
            <SvgIcon sx={{ width: 26, height: 28, color: '#7F746A' }}>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="26"
                height="28"
                viewBox="0 0 26 28"
                fill="none"
              >
                <path
                  d="M1.88891 3C1.65315 3 1.42706 3.09658 1.26035 3.26849C1.09365 3.44039 1 3.67355 1 3.91667C1 4.15978 1.09365 4.39294 1.26035 4.56485C1.42706 4.73676 1.65315 4.83333 1.88891 4.83333H3.28864C3.50309 4.83326 3.71033 4.91314 3.87216 5.05824C4.034 5.20334 4.13951 5.40388 4.16925 5.62289L5.6555 16.5214C5.74494 17.178 6.06142 17.7792 6.54664 18.2142C7.03187 18.6493 7.65318 18.8889 8.29614 18.8889H20.5559C20.7917 18.8889 21.0178 18.7923 21.1845 18.6204C21.3512 18.4485 21.4448 18.2153 21.4448 17.9722C21.4448 17.7291 21.3512 17.4959 21.1845 17.324C21.0178 17.1521 20.7917 17.0556 20.5559 17.0556H8.29614C8.08169 17.0556 7.87445 16.9758 7.71261 16.8307C7.55078 16.6856 7.44527 16.485 7.41553 16.266L7.27331 15.2234H20.1352C20.7046 15.2237 21.2591 15.0361 21.7176 14.6879C22.1762 14.3398 22.5146 13.8495 22.6834 13.2887L24.9602 5.72556C25.0014 5.58843 25.0108 5.44324 24.9876 5.30168C24.9644 5.16012 24.9094 5.02615 24.8268 4.91056C24.7442 4.79497 24.6365 4.701 24.5123 4.63621C24.388 4.57142 24.2508 4.53763 24.1116 4.53756H5.68157C5.46195 4.07649 5.12149 3.68807 4.69876 3.41632C4.27604 3.14457 3.78796 3.00035 3.28982 3H1.88891ZM6.06676 6.37089H22.905L20.985 12.7448C20.9286 12.9316 20.8156 13.0949 20.6627 13.2108C20.5098 13.3267 20.325 13.3891 20.1352 13.3889H7.02323L6.06676 6.37089ZM8.36962 20.7222C7.81953 20.7222 7.29198 20.9476 6.903 21.3487C6.51403 21.7498 6.29551 22.2938 6.29551 22.8611C6.29551 23.4284 6.51403 23.9724 6.903 24.3735C7.29198 24.7747 7.81953 25 8.36962 25C8.91971 25 9.44727 24.7747 9.83624 24.3735C10.2252 23.9724 10.4437 23.4284 10.4437 22.8611C10.4437 22.2938 10.2252 21.7498 9.83624 21.3487C9.44727 20.9476 8.91971 20.7222 8.36962 20.7222ZM16.4124 22.8611C16.4124 22.2938 16.631 21.7498 17.0199 21.3487C17.4089 20.9476 17.9365 20.7222 18.4866 20.7222C19.0366 20.7222 19.5642 20.9476 19.9532 21.3487C20.3422 21.7498 20.5607 22.2938 20.5607 22.8611C20.5607 23.4284 20.3422 23.9724 19.9532 24.3735C19.5642 24.7747 19.0366 25 18.4866 25C17.9365 25 17.4089 24.7747 17.0199 24.3735C16.631 23.9724 16.4124 23.4284 16.4124 22.8611Z"
                  fill="currentColor"
                />
              </svg>
            </SvgIcon>

            {itemCount > 0 && (
              <Box
                sx={{
                  position: 'absolute',
                  top: 2,
                  right: 4,
                  width: 10,
                  height: 10,
                  borderRadius: '50%',
                  backgroundColor: '#2AB573',
                }}
              />
            )}
          </Box>
        ) : (
          <Box
            sx={{
              display: 'flex',
              alignItems: 'center',
              gap: 1.25,
              px: 1.25,
              py: 0.75,
              borderRadius: '999px',
            }}
          >
            <SvgIcon sx={{ width: 26, height: 28, color: '#7F746A' }}>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="26"
                height="28"
                viewBox="0 0 26 28"
                fill="none"
              >
                <path
                  d="M1.88891 3C1.65315 3 1.42706 3.09658 1.26035 3.26849C1.09365 3.44039 1 3.67355 1 3.91667C1 4.15978 1.09365 4.39294 1.26035 4.56485C1.42706 4.73676 1.65315 4.83333 1.88891 4.83333H3.28864C3.50309 4.83326 3.71033 4.91314 3.87216 5.05824C4.034 5.20334 4.13951 5.40388 4.16925 5.62289L5.6555 16.5214C5.74494 17.178 6.06142 17.7792 6.54664 18.2142C7.03187 18.6493 7.65318 18.8889 8.29614 18.8889H20.5559C20.7917 18.8889 21.0178 18.7923 21.1845 18.6204C21.3512 18.4485 21.4448 18.2153 21.4448 17.9722C21.4448 17.7291 21.3512 17.4959 21.1845 17.324C21.0178 17.1521 20.7917 17.0556 20.5559 17.0556H8.29614C8.08169 17.0556 7.87445 16.9758 7.71261 16.8307C7.55078 16.6856 7.44527 16.485 7.41553 16.266L7.27331 15.2234H20.1352C20.7046 15.2237 21.2591 15.0361 21.7176 14.6879C22.1762 14.3398 22.5146 13.8495 22.6834 13.2887L24.9602 5.72556C25.0014 5.58843 25.0108 5.44324 24.9876 5.30168C24.9644 5.16012 24.9094 5.02615 24.8268 4.91056C24.7442 4.79497 24.6365 4.701 24.5123 4.63621C24.388 4.57142 24.2508 4.53763 24.1116 4.53756H5.68157C5.46195 4.07649 5.12149 3.68807 4.69876 3.41632C4.27604 3.14457 3.78796 3.00035 3.28982 3H1.88891ZM6.06676 6.37089H22.905L20.985 12.7448C20.9286 12.9316 20.8156 13.0949 20.6627 13.2108C20.5098 13.3267 20.325 13.3891 20.1352 13.3889H7.02323L6.06676 6.37089ZM8.36962 20.7222C7.81953 20.7222 7.29198 20.9476 6.903 21.3487C6.51403 21.7498 6.29551 22.2938 6.29551 22.8611C6.29551 23.4284 6.51403 23.9724 6.903 24.3735C7.29198 24.7747 7.81953 25 8.36962 25C8.91971 25 9.44727 24.7747 9.83624 24.3735C10.2252 23.9724 10.4437 23.4284 10.4437 22.8611C10.4437 22.2938 10.2252 21.7498 9.83624 21.3487C9.44727 20.9476 8.91971 20.7222 8.36962 20.7222ZM16.4124 22.8611C16.4124 22.2938 16.631 21.7498 17.0199 21.3487C17.4089 20.9476 17.9365 20.7222 18.4866 20.7222C19.0366 20.7222 19.5642 20.9476 19.9532 21.3487C20.3422 21.7498 20.5607 22.2938 20.5607 22.8611C20.5607 23.4284 20.3422 23.9724 19.9532 24.3735C19.5642 24.7747 19.0366 25 18.4866 25C17.9365 25 17.4089 24.7747 17.0199 24.3735C16.631 23.9724 16.4124 23.4284 16.4124 22.8611Z"
                  fill="currentColor"
                />
              </svg>
            </SvgIcon>

            {itemCount > 0 && (
              <Box
                sx={{
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  minWidth: 20,
                  height: 20,
                  borderRadius: '16px',
                  backgroundColor: '#FFFF',
                  fontSize: '12px',
                  fontWeight: 700,
                  color: '#7F746A',
                }}
              >
                {itemCount}
              </Box>
            )}
          </Box>
        )}
      </IconButton>

      <CartMenu anchorEl={anchorEl} open={open} onClose={handleClose} />
    </>
  );
}
